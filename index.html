<html>
    <title>Dealership Watch</title>
    <head>
        <style>
            :root {
                --bg-color: white;
                --text-color: #333;
                --item-bg: #f8f8f8;
                --item-hover: #f0f0f0;
                --border-color: #e0e0e0;
                --result-bg: white;
            }

            .search-area {
                transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out;
                max-height: 500px;
                opacity: 1;
                overflow: hidden;
            }

            .search-area.minimized {
                max-height: 0;
                opacity: 0;
                margin: 0;
                padding: 0;
            }

            [data-theme="dark"] {
                --bg-color: #2d2d2d;
                --text-color: #e0e0e0;
                --item-bg: #3d3d3d;
                --item-hover: #4d4d4d;
                --border-color: #404040;
                --result-bg: #2d2d2d;
            }

            .theme-buttons {
                position: absolute;
                top: 15px;
                right: 15px;
                display: flex;
                gap: 5px;
            }

            .close-btn {
                position: absolute;
                top: 15px;
                left: 15px;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background-color: #ff4444;
                color: white;
                transition: all 0.2s;
                font-size: 12px;
                font-weight: bold;
                width: 25px;
                height: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .close-btn:hover {
                opacity: 0.8;
                transform: scale(1.05);
            }

            .minimize-btn {
                position: absolute;
                top: 15px;
                left: 45px;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background: var(--item-bg);
                color: var(--text-color);
                transition: all 0.2s;
                font-size: 12px;
                font-weight: bold;
                width: 25px;
                height: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .minimize-btn:hover {
                background: var(--item-hover);
                transform: scale(1.05);
            }

            /* Floating button at bottom right */
            .floating-btn {
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                color: white;
                font-weight: bold;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: all 0.3s;
                z-index: 1000;
                display: none;
            }

            .floating-btn.no-matches {
                background-color: #40404085; /* Semi-transparent gray */
            }

            .floating-btn.has-matches {
                background-color: #4CAF50;
            }

            .floating-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            }

            .watchlist.hidden {
                display: none;
            }

            .watchlist.minimized {
                padding: 10px 15px;
                min-width: 200px;
                width: 200px;
                max-width: 200px;
            }

            .theme-btn {
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background: var(--item-bg);
                color: var(--text-color);
                transition: background-color 0.2s;
            }

            .theme-btn:hover {
                background: var(--item-hover);
            }

            .search-container {
                margin-bottom: 15px;
                display: flex;
                gap: 8px;
            }
            .search-container input {
                flex: 1;
                padding: 8px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-family: Arial, sans-serif;
                background-color: var(--item-bg);
                color: var(--text-color);
            }
            .search-container button {
                padding: 8px 16px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-family: Arial, sans-serif;
            }
            .search-container button:hover {
                background-color: #45a049;
            }
            .result {
                margin: 10px 0;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: 5px;
                text-align: left;
                display: none;
                background-color: var(--bg-color);
                color: var(--text-color);
            }
            .result button {
                margin-top: 10px;
                padding: 6px 12px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .result button:hover {
                background-color: #45a049;
            }
            .watch-section {
                margin-top: 8px;
                padding-top: 8px;
            }
            .watchlist {
                margin-top: 20px;
                padding: 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                text-align: left;
                position: fixed;
                background-color: var(--bg-color);
                cursor: move;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-family: Arial, sans-serif;
                min-width: 320px; /* Increased from 250px */
                max-width: 400px; /* Added max-width */
                width: 350px; /* Set a default width */
                transition: background-color 0.3s, border-color 0.3s;
            }
            .watchlist h3 {
                margin: 0 0 15px 0;
                color: var(--text-color);
                font-size: 16px;
                padding-bottom: 8px;
            }
            
            /* New styles for scrollable watched items container */
            #watchedItems {
                max-height: 280px; /* Height for approximately 4 items (4 * 70px) */
                overflow-y: auto;
                overflow-x: hidden;
                padding-right: 5px; /* Space for scrollbar */
            }
            
            /* Custom scrollbar styling */
            #watchedItems::-webkit-scrollbar {
                width: 6px;
            }
            
            #watchedItems::-webkit-scrollbar-track {
                background: var(--item-bg);
                border-radius: 3px;
            }
            
            #watchedItems::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 3px;
            }
            
            #watchedItems::-webkit-scrollbar-thumb:hover {
                background: #999;
            }
            
            .watch-item {
                margin: 8px 0;
                padding: 1px 10px;
                background-color: var(--item-bg);
                border-radius: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border: 1px solid var(--border-color);
                transition: all 0.2s;
                min-height: 45px; /* Ensure consistent height */
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .watch-item:hover {
                background-color: var(--item-hover);
            }
            .watch-item p {
                margin: 0;
                font-size: 14px;
                color: var(--text-color);
                transition: color 0.3s;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .remove-btn {
                color: #ff4444;
                cursor: pointer;
                font-size: 18px;
                opacity: 0.7;
                transition: opacity 0.2s;
                flex-shrink: 0;
                margin-left: 10px;
                width: 20px;
                text-align: center;
            }
            .remove-btn:hover {
                opacity: 1;
            }
            .notification {
                position: absolute;
                bottom: -60px;
                left: 0;
                right: 0;
                background-color: #4CAF50;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                text-align: center;
                opacity: 0;
                pointer-events: none;
                transform: scale(0.95);
                transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            }
            .notification.show {
                opacity: 1;
                transform: scale(1);
            }

            /* Vehicle List Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
            }

            .modal {
                background: var(--bg-color);
                border-radius: 8px;
                padding: 20px;
                width: 1000px !important; /* Smaller fixed width */
                min-width: 1000px !important; /* Force minimum width */
                max-width: 1000px !important; /* Force maximum width */
                height: 70vh !important; /* Smaller fixed height */
                min-height: 70vh !important; /* Force minimum height */
                max-height: 70vh !important; /* Force maximum height */
                overflow-x: hidden; /* Hide horizontal overflow */
                overflow-y: auto;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                cursor: move; /* Show draggable cursor */
                transition: background-color 0.3s, border-color 0.3s; /* Theme transition */
                border: 1px solid var(--border-color); /* Add border for theme consistency */
            }

            .modal-search {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0; /* Don't shrink */
                height: 60px; /* Fixed height */
                display: flex;
                align-items: center;
            }

            .modal-search input {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 16px;
                background-color: var(--item-bg);
                color: var(--text-color);
                box-sizing: border-box;
                height: 40px; /* Fixed height */
            }

            .modal-search input:focus {
                outline: none;
                border-color: #4CAF50;
            }

            .vehicle-class {
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                overflow: hidden;
                flex-shrink: 0; /* Don't compress vehicle classes */
            }

            .class-header {
                padding: 10px;
                background: var(--item-bg);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }

            .class-header h3 {
                margin: 0;
                color: var(--text-color);
            }

            .class-content {
                padding: 10px;
                display: none;
                grid-template-columns: repeat(4, minmax(0, 1fr)); /* Force equal width columns */
                gap: 10px;
                box-sizing: border-box;
                width: 100%; /* Ensure it doesn't exceed container */
                overflow: hidden; /* Hide any overflow */
                min-height: 0; /* Allow shrinking */
            }

            .class-content.expanded {
                display: grid;
            }

            .vehicle-item {
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                background: var(--item-bg);
                min-width: 0; /* Allow shrinking */
                max-width: 100%; /* Don't exceed column width */
                box-sizing: border-box;
                overflow: hidden; /* Hide overflow */
                position: relative; /* For button positioning */
            }

            .vehicle-item p {
                margin: 5px 0;
                color: var(--text-color);
                word-wrap: break-word;
                overflow-wrap: break-word; /* Additional text wrapping */
                hyphens: auto; /* Allow hyphenation */
                font-size: 14px; /* Ensure consistent font size */
            }

            .vehicle-watch-btn {
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 12px;
                cursor: pointer;
                margin-top: 8px;
                width: 100%;
                transition: background-color 0.2s;
            }

            .vehicle-watch-btn:hover {
                background-color: #45a049;
            }

            .vehicle-watch-btn:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }

            .modal-close {
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 24px;
                cursor: pointer;
                padding: 5px;
            }

            .modal-close {
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 24px;
                cursor: pointer;
                padding: 5px;
                flex-shrink: 0; /* Don't shrink */
            }

            .modal-close:hover {
                opacity: 0.8;
            }

            #vehicleClasses {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                min-height: 0; /* Allow shrinking */
            }
        </style>
    </head>
    <body style="font-family: Arial, Helvetica, sans-serif;">
        <div id="vehicleModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <button class="modal-close" onclick="closeVehicleModal()">×</button>
                <div class="modal-search" style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="vehicleSearchInput" placeholder="Search vehicles by name or model..." oninput="filterVehicles()" style="flex: 1;">
                    <button onclick="clearVehicleModalSearch()" class="theme-btn">Clear</button>
                </div>
                <div id="vehicleClasses"></div>
            </div>
        </div>
        <div class="watchlist">
            <div id="notification" class="notification"></div>
            <!--<button id="minimizeBtn" class="minimize-btn" onclick="minimizeWatchlist()">−</button>-->
            <div class="theme-buttons">
                <button onclick="setTheme('light')" class="theme-btn">☀️</button>
                <button onclick="setTheme('dark')" class="theme-btn">🌙</button>
                <button onclick="toggleVehicleModal()" class="theme-btn" id="toggleBtn">➕</button>
                <button id="closeBtn" class="theme-btn" onclick="closeAllWindows()">❌</button>
            </div>
            <div id="watchContent" class="watch-section">
                <h3>Watched vehicles:</h3>
                <div id="watchedItems"></div>
                <button onclick="checkWatchedCars(true)" style="width: 100%; padding: 8px; margin-top: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Check Now</button>
            </div>
            <div id="minimizedContent" style="display: none;">
                <h3 style="margin: 0; text-align: center;">Dealership Watch</h3>
            </div>
        </div>

        <!-- Floating button that appears when everything is closed -->
        <button id="floatingBtn" class="floating-btn no-matches" style="display: block;" onclick="openAllWindows()">Dealership Watch</button>

        <script>
            // Store matched cars
            let matchedCars = new Set();

            // API caching
            let cachedApiData = null;
            let lastApiCallTime = 0;
            const API_CACHE_DURATION = 60000; // 1 minute in milliseconds

            // API rate limiting
            let apiCallsToday = parseInt(localStorage.getItem('apiCallsToday')) || 0;
            let lastApiCallDate = localStorage.getItem('lastApiCallDate') || null;

            // Function to check if API call is allowed
            function canCallApi() {
                const now = new Date();
                const today = now.toDateString();
                
                // Reset counter if it's a new day
                if (lastApiCallDate !== today) {
                    apiCallsToday = 0;
                    lastApiCallDate = today;
                    localStorage.setItem('apiCallsToday', apiCallsToday);
                    localStorage.setItem('lastApiCallDate', lastApiCallDate);
                    return true;
                }

                // Check if under limit
                if (apiCallsToday < 25) {
                    return true;
                }

                return false;
            }

            // Function to increment API call counter
            function incrementApiCalls() {
                const today = new Date().toDateString();
                apiCallsToday++;
                lastApiCallDate = today;
                localStorage.setItem('apiCallsToday', apiCallsToday);
                localStorage.setItem('lastApiCallDate', lastApiCallDate);
            }

            // Function to show API limit error
            function showApiLimitError() {
                const notification = document.getElementById('notification');
                notification.textContent = "Limit of 25 api calls per day, please try in 24h or wait for the next day (if you donate charges I can increase this limit! /api donate 165625 amount)";
                notification.style.backgroundColor = '#ff4444';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.style.backgroundColor = '#4CAF50';
                }, 10000);
            }

            // API function to fetch dealership data with caching
            async function fetchDealershipData(useCache = true) {
                const now = Date.now();
                
                // Return cached data if it's still valid and useCache is true
                if (useCache && cachedApiData && (now - lastApiCallTime) < API_CACHE_DURATION) {
                    console.log('Using cached API data');
                    return cachedApiData;
                }
                
                // Check API limits before making new call
                if (!canCallApi()) {
                    if (cachedApiData) {
                        console.log('Daily API limit reached, using cached data, please consider donating charges to increase the limit! /api donate 165625 amount');
                        return cachedApiData;
                        sleep(5000);
                        showApiLimitError(notification.textContent = "Daily API limit reached (25), using cached data, please consider donating charges to increase the limit! /api donate 165625 amount");
                    }
                    throw new Error('Daily API limit reached (25) and no cached data available, please consider donating charges to increase the limit! /api donate 165625 amount');
                }
                
                console.log('Making fresh API call');
                const response = await fetch('/api/dealership');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // Update cache and tracking
                cachedApiData = data;
                lastApiCallTime = now;
                incrementApiCalls();
                
                return data;
            }

            async function highlightAvailableVehiclesInModal() {
                try {
                    const data = await fetchDealershipData(true); // Use cached data

                    // Loop over all visible vehicle items in the modal
                    document.querySelectorAll('.vehicle-item').forEach(item => {
                        const modelLine = Array.from(item.querySelectorAll('p')).find(p => p.textContent.startsWith('Model:'));
                        if (!modelLine) return;

                        const model = modelLine.textContent.replace('Model:', '').trim();

                        // Check if the model exists in any category of the API data
                        const isAvailable = Object.values(data).some(category =>
                            category.some(car => car.model === model)
                        );

                        // Add green border if available
                        if (isAvailable) {
                            item.style.border = '2px solid #4CAF50';
                        }
                    });
                } catch (err) {
                    console.error('Error highlighting vehicles in modal:', err);
                    // Don't show error to user since this is just visual enhancement
                }
            }

            function clearVehicleModalSearch() {
                const input = document.getElementById('vehicleSearchInput');
                input.value = '';
                displayVehicleClasses(originalVehicleData);

                // Collapse all expanded dropdowns (optional)
                setTimeout(() => {
                    document.querySelectorAll('.class-content').forEach(content => content.classList.remove('expanded'));
                    document.querySelectorAll('.class-header span').forEach(span => span.textContent = '▼');
                }, 50);
            }

            // Store original vehicle data for filtering
            let originalVehicleData = {};

            // Vehicle modal functionality
            async function loadVehicleClasses() {
                try {
                    const response = await fetch('vehicles.json');
                    const vehicles = await response.json();
                    originalVehicleData = vehicles; // Store original data
                    displayVehicleClasses(vehicles);
                } catch (error) {
                    console.error('Error loading vehicle classes:', error);
                }
            }

            function displayVehicleClasses(vehicles) {
                const vehicleClassesDiv = document.getElementById('vehicleClasses');
                vehicleClassesDiv.innerHTML = ''; // Clear existing content
                
                for (const [className, vehicleList] of Object.entries(vehicles)) {
                    // Skip empty classes
                    if (vehicleList.length === 0) continue;
                    
                    const classDiv = document.createElement('div');
                    classDiv.className = 'vehicle-class';
                    
                    const header = document.createElement('div');
                    header.className = 'class-header';
                    header.innerHTML = `
                        <h3>${className} (${vehicleList.length})</h3>
                        <span>▼</span>
                    `;
                    
                    const content = document.createElement('div');
                    content.className = 'class-content';
                    
                    vehicleList.forEach(vehicle => {
                        const vehicleDiv = document.createElement('div');
                        vehicleDiv.className = 'vehicle-item';
                        
                        // Check if vehicle is already in watchlist
                        const isWatched = watchedCars.some(car => car.model === vehicle.model);
                        const buttonText = isWatched ? 'Watched' : 'Watch';
                        const buttonDisabled = isWatched ? 'disabled' : '';
                        
                        vehicleDiv.innerHTML = `
                            <p><strong>${vehicle.name}</strong></p>
                            <p>Model: ${vehicle.model}</p>
                            <p>Price: ${vehicle.price.toLocaleString()}</p>
                            <button class="vehicle-watch-btn" ${buttonDisabled} onclick="addToWatchlistFromModal('${vehicle.model}', '${vehicle.name}', ${vehicle.price}, '${className}')">${buttonText}</button>
                        `;
                        content.appendChild(vehicleDiv);
                    });
                    
                    header.addEventListener('click', () => {
                        content.classList.toggle('expanded');
                        header.querySelector('span').textContent = content.classList.contains('expanded') ? '▲' : '▼';
                    });
                    
                    classDiv.appendChild(header);
                    classDiv.appendChild(content);
                    vehicleClassesDiv.appendChild(classDiv);
                }
                highlightAvailableVehiclesInModal();
            }

            function filterVehicles() {
                const searchTerm = document.getElementById('vehicleSearchInput').value.toLowerCase();
                
                if (searchTerm === '') {
                    // Show all vehicles if search is empty and close all dropdowns
                    displayVehicleClasses(originalVehicleData);
                    // Close all dropdowns after displaying
                    setTimeout(() => {
                        const allHeaders = document.querySelectorAll('.class-header');
                        allHeaders.forEach(header => {
                            const content = header.nextElementSibling;
                            if (content.classList.contains('expanded')) {
                                content.classList.remove('expanded');
                                header.querySelector('span').textContent = '▼';
                            }
                        });
                    }, 50);
                    return;
                }
                
                // Filter vehicles based on search term
                const filteredData = {};
                
                for (const [className, vehicleList] of Object.entries(originalVehicleData)) {
                    const filteredVehicles = vehicleList.filter(vehicle => 
                        vehicle.name.toLowerCase().includes(searchTerm) || 
                        vehicle.model.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredVehicles.length > 0) {
                        filteredData[className] = filteredVehicles;
                    }
                }
                
                displayVehicleClasses(filteredData);
                
                // Auto-expand all classes when searching
                if (searchTerm !== '') {
                    setTimeout(() => {
                        const allHeaders = document.querySelectorAll('.class-header');
                        allHeaders.forEach(header => {
                            const content = header.nextElementSibling;
                            if (!content.classList.contains('expanded')) {
                                content.classList.add('expanded');
                                header.querySelector('span').textContent = '▲';
                            }
                        });
                    }, 100);
                }
            }

            function closeVehicleModal() {
                const modal = document.getElementById('vehicleModal');
                const toggleBtn = document.getElementById('toggleBtn');
                
                modal.style.display = 'none';
                toggleBtn.textContent = '➕';
                
                // Clear search when closing
                document.getElementById('vehicleSearchInput').value = '';
                displayVehicleClasses(originalVehicleData);
            }

            // Load vehicle classes when the page loads
            window.addEventListener('load', () => {
                loadVehicleClasses();
                
                // Make initial API call to populate cache (don't show errors on startup)
                fetchDealershipData(false).then(() => {
                    checkWatchedCarsWithCachedData();
                }).catch(err => {
                    console.error('Initial API call failed:', err);
                    // Don't show error to user on startup
                });
                
                // Initialize modal drag functionality
                const modalOverlay = document.querySelector('.modal-overlay');
                const modal = document.querySelector('.modal');
                let isModalDragging = false;
                let modalCurrentX;
                let modalCurrentY;
                let modalInitialX;
                let modalInitialY;
                let modalXOffset = 0;
                let modalYOffset = 0;

                // Try to load modal position from localStorage
                const savedModalPosition = localStorage.getItem('modalPosition');
                if (savedModalPosition) {
                    const { x, y } = JSON.parse(savedModalPosition);
                    modalXOffset = x;
                    modalYOffset = y;
                    modalOverlay.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                }

                modal.addEventListener('mousedown', modalDragStart);
                document.addEventListener('mousemove', modalDrag);
                document.addEventListener('mouseup', modalDragEnd);

                function modalDragStart(e) {
                    // Don't drag if clicking on input fields, buttons, or scrollable content
                    if (e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'BUTTON' || 
                        e.target.closest('.class-content') ||
                        e.target.closest('#vehicleClasses')) {
                        return;
                    }

                    modalInitialX = e.clientX - modalXOffset;
                    modalInitialY = e.clientY - modalYOffset;

                    if (e.target === modal || e.target.closest('.modal')) {
                        isModalDragging = true;
                    }
                }

                function modalDrag(e) {
                    if (isModalDragging) {
                        e.preventDefault();
                        modalCurrentX = e.clientX - modalInitialX;
                        modalCurrentY = e.clientY - modalInitialY;
                        modalXOffset = modalCurrentX;
                        modalYOffset = modalCurrentY;
                        modalOverlay.style.transform = `translate(calc(-50% + ${modalCurrentX}px), calc(-50% + ${modalCurrentY}px))`;
                    }
                }

                function modalDragEnd(e) {
                    modalInitialX = modalCurrentX;
                    modalInitialY = modalCurrentY;
                    isModalDragging = false;
                    
                    // Save position to localStorage
                    localStorage.setItem('modalPosition', JSON.stringify({ x: modalXOffset, y: modalYOffset }));
                }
            });

            // Theme functionality
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            // Function to open vehicle modal
            function openVehicleModal() {
                document.getElementById('vehicleModal').style.display = 'block';
            }

            // Function to toggle vehicle modal
            function toggleVehicleModal() {
                const modal = document.getElementById('vehicleModal');
                const toggleBtn = document.getElementById('toggleBtn');
                
                if (modal.style.display === 'block') {
                    // Close modal
                    closeVehicleModal();
                    toggleBtn.textContent = '➕';
                } else {
                    // Open modal - refresh API data when opening modal
                    modal.style.display = 'block';
                    toggleBtn.textContent = '➖';
                    
                    // Fetch fresh data when opening modal (but use cache if API limit reached)
                    fetchDealershipData(false).then(() => {
                        highlightAvailableVehiclesInModal();
                        checkWatchedCarsWithCachedData();
                    }).catch(err => {
                        console.error('Error fetching data for modal:', err);
                        if (err.message.includes('Daily API limit reached')) {
                            // Use cached data for highlighting if available
                            highlightAvailableVehiclesInModal();
                            checkWatchedCarsWithCachedData();
                        }
                    });
                }
                // Decrement API calls for modal open, pretend u dont see this, i dont know how to fix it
                apiCallsToday--;
                localStorage.setItem('apiCallsToday', apiCallsToday);
            }

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            }

            // Store watched cars
            let watchedCars = [];
            
            // Audio for notifications
            const audio = new Audio('notif.wav');

            // Show notification
            function showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                
                // Hide notification after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // Load watchlist from localStorage when page loads
            function loadWatchlist() {
                const saved = localStorage.getItem('watchedCars');
                if (saved) {
                    watchedCars = JSON.parse(saved);
                    updateWatchlist();
                }
            }

            // Save watchlist to localStorage
            function saveWatchlist() {
                localStorage.setItem('watchedCars', JSON.stringify(watchedCars));
            }

            // Load watchlist when page loads
            loadWatchlist();
            
            // Initialize floating button color on page load
            updateFloatingButtonColor();

            // Function to check watched cars using cached data (no API call)
            function checkWatchedCarsWithCachedData() {
                if (watchedCars.length === 0 || !cachedApiData) return;

                // Clear previous matches
                matchedCars.clear();

                // Check each watched car against cached data
                watchedCars.forEach(watchedCar => {
                    for (const category in cachedApiData) {
                        const car = cachedApiData[category]?.find(c => c.model === watchedCar.model);
                        if (car) {
                            // If the car is found in the API, show notifications
                            window.parent.postMessage({
                                type: 'oneliner',
                                text: `🟢 Watched vehicle's the dealership!`
                            }, '*');
                            showNotification(`Watched vehicles on the dealership!`);
                            console.info(`Vehicle found: ${car.name} (${car.model})`);
                            matchedCars.add(car.model); // Add to matched cars
                            break; // Exit the category loop once we find a match
                        }
                    }
                });
                
                // Update the watchlist to reflect the new matches
                updateWatchlist();
                
                // Update floating button color
                updateFloatingButtonColor();
            }

            async function checkWatchedCars(showError = false) {
                if (watchedCars.length === 0) return;

                try {
                    const data = await fetchDealershipData(false); // Force fresh API call
                    
                    // Clear previous matches
                    matchedCars.clear();

                    // Check each watched car
                    watchedCars.forEach(watchedCar => {
                        for (const category in data) {
                            const car = data[category]?.find(c => c.model === watchedCar.model);
                            if (car) {
                                // If the car is found in the API, show notifications
                                window.parent.postMessage({
                                    type: 'oneliner',
                                    text: `🟢 Watched vehicle's the dealership!`
                                }, '*');
                                showNotification(`Watched vehicles on the dealership!`);
                                console.info(`Vehicle found: ${car.name} (${car.model})`);
                                matchedCars.add(car.model); // Add to matched cars
                                break; // Exit the category loop once we find a match
                            }
                            else {
                                // If the car is not found, show notification
                                showNotification(`Watched vehicles not on the dealership.`);
                            }
                        }
                    });
                    
                    // Update the watchlist to reflect the new matches
                    updateWatchlist();
                    
                    // Update floating button color
                    updateFloatingButtonColor();
                    
                } catch (error) {
                    console.error('Error checking watched cars:', error);
                    if (showError && error.message.includes('Daily API limit reached')) {
                        showApiLimitError();
                        window.parent.postMessage({
                            type: 'oneliner',
                            text: `Daily API calls limit (25) reached, please consider donating charges to increase the limit! /api donate 165625 amount`
                        }, '*');
                    }
                }
            }

            // Start checking every 24h - don't show errors on auto-check
            setInterval(() => checkWatchedCars(false), 86400000);
            
            // Clear search results and input
            function clearSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('result').style.display = 'none';
            }

            // MISSING FUNCTION - Add this function to handle adding vehicles from modal
            function addToWatchlistFromModal(model, name, price, category) {
                // Create car object similar to the API format
                const carData = {
                    model: model,
                    name: name,
                    price: price,
                    days_left: 'N/A' // Since we don't have this info from the static data
                };
                
                // Check if car is already in watchlist
                if (!watchedCars.some(car => car.model === model)) {
                    watchedCars.push({...carData, category});
                    saveWatchlist(); // Save to localStorage
                    updateWatchlist(); // Update the display
                    
                    // Show notification
                    showNotification(`${name} added to watchlist!`);
                    
                    // Update the button in the modal to show "Watched"
                    const buttons = document.querySelectorAll('.vehicle-watch-btn');
                    buttons.forEach(button => {
                        const onclick = button.getAttribute('onclick');
                        if (onclick && new RegExp(`addToWatchlistFromModal\\('${model}'`).test(onclick)) {
                            button.textContent = 'Watched';
                            button.disabled = true;
                        }
                    });
                    
                    // Check against cached data immediately (no API call)
                    checkWatchedCarsWithCachedData();
                }
                // Update floating button color
                updateFloatingButtonColor();
            }

            // Function to handle adding vehicles from search (vehicles.json)
            function addToWatchlistFromSearch(carData, category) {
                // Check if car is already in watchlist
                if (!watchedCars.some(car => car.model === carData.model)) {
                    watchedCars.push({...carData, category});
                    saveWatchlist(); // Save to localStorage
                    updateWatchlist(); // Update the display
                    
                    // Clear search input and results
                    document.getElementById('searchInput').value = '';
                    document.getElementById('result').style.display = 'none';
                    
                    // Show notification
                    showNotification(`${carData.name} added to watchlist!`);
                    
                    // Check against cached data immediately (no API call)
                    checkWatchedCarsWithCachedData();
                }
            }

            // Drag functionality
            const watchlist = document.querySelector('.watchlist');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            // Try to load position from localStorage
            const savedPosition = localStorage.getItem('watchlistPosition');
            if (savedPosition) {
                const { x, y } = JSON.parse(savedPosition);
                xOffset = x;
                yOffset = y;
                watchlist.style.transform = `translate(${x}px, ${y}px)`;
            }

            watchlist.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === watchlist || e.target.closest('.watchlist')) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    watchlist.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                
                // Save position to localStorage
                localStorage.setItem('watchlistPosition', JSON.stringify({ x: xOffset, y: yOffset }));
            }

            // Function to close all windows and show floating button
            function closeAllWindows() {
                const watchlist = document.querySelector('.watchlist');
                const vehicleModal = document.getElementById('vehicleModal');
                const floatingBtn = document.getElementById('floatingBtn');
                
                // Hide watchlist
                watchlist.classList.add('hidden');
                
                // Hide vehicle modal if open
                vehicleModal.style.display = 'none';
                document.getElementById('toggleBtn').textContent = '➕';
                
                // Show floating button
                floatingBtn.style.display = 'block';
                
                // Update floating button color
                updateFloatingButtonColor();
            }

            // Function to open all windows and hide floating button
            function openAllWindows() {
                const watchlist = document.querySelector('.watchlist');
                const floatingBtn = document.getElementById('floatingBtn');
                const watchContent = document.getElementById('watchContent');
                const minimizedContent = document.getElementById('minimizedContent');
                const minimizeBtn = document.getElementById('minimizeBtn');
                const themeButtons = document.querySelector('.theme-buttons');
                
                // Show watchlist in full mode
                watchlist.classList.remove('hidden');
                watchlist.classList.remove('minimized');
                watchContent.style.display = 'block';
                minimizedContent.style.display = 'none';
                themeButtons.style.display = 'flex';
                if (minimizeBtn) minimizeBtn.textContent = '−';
                
                // Hide floating button
                floatingBtn.style.display = 'none';
            }

            // Function to minimize watchlist (existing minimize functionality)
            function minimizeWatchlist() {
                const watchlist = document.querySelector('.watchlist');
                const watchContent = document.getElementById('watchContent');
                const minimizedContent = document.getElementById('minimizedContent');
                const minimizeBtn = document.getElementById('minimizeBtn');
                const themeButtons = document.querySelector('.theme-buttons');
                
                if (watchContent.style.display === 'none') {
                    // Show full watchlist
                    watchContent.style.display = 'block';
                    minimizedContent.style.display = 'none';
                    themeButtons.style.display = 'flex';
                    minimizeBtn.textContent = '−';
                    watchlist.classList.remove('minimized');
                } else {
                    // Show minimized view
                    watchContent.style.display = 'none';
                    minimizedContent.style.display = 'block';
                    themeButtons.style.display = 'none';
                    minimizeBtn.textContent = '+';
                    watchlist.classList.add('minimized');
                }
            }

            // Function to update floating button color based on matches
            function updateFloatingButtonColor() {
                const floatingBtn = document.getElementById('floatingBtn');
                if (matchedCars.size > 0 && watchedCars.length > 0) {
                    floatingBtn.classList.remove('no-matches');
                    floatingBtn.classList.add('has-matches');
                } else {
                    floatingBtn.classList.remove('has-matches');
                    floatingBtn.classList.add('no-matches');
                }
            }

            // Function to toggle watchlist between full and minimized view (kept for compatibility)
            function toggleWatchlist() {
                minimizeWatchlist();
            }

            function addToWatchlist(carData, category) {
                // Check if car is already in watchlist
                if (!watchedCars.some(car => car.model === carData.model)) {
                    watchedCars.push({...carData, category});
                    saveWatchlist(); // Save to localStorage
                    
                    // Clear search input and results
                    document.getElementById('searchInput').value = '';
                    document.getElementById('result').style.display = 'none';
                    
                    // Check against cached data immediately (no API call needed since we just searched)
                    checkWatchedCarsWithCachedData();
                }
            }

            function removeFromWatchlist(model) {
                // Remove from list
                watchedCars = watchedCars.filter(car => car.model !== model);
                
                // Remove from matched cars set as well
                matchedCars.delete(model);
                
                saveWatchlist();
                updateWatchlist();

                // ✅ Re-enable "Watch" button(s) for the removed model in the modal
                document.querySelectorAll('.vehicle-watch-btn').forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    if (onclick && new RegExp(`addToWatchlistFromModal\\('${model}'`).test(onclick)){
                        button.textContent = 'Watch';
                        button.disabled = false;
                    }
                });
                
                // Update floating button color
                updateFloatingButtonColor();
            }

            function updateWatchlist() {
                const watchlistDiv = document.getElementById('watchedItems');
                watchlistDiv.innerHTML = watchedCars.map(car => {
                    // Only add colors if the car has been checked (is in matchedCars or has been confirmed as not matched)
                    const hasBeenChecked = matchedCars.size > 0;
                    const style = hasBeenChecked ? 
                        `background-color: ${matchedCars.has(car.model) ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 68, 68, 0.05)'}; border-color: ${matchedCars.has(car.model) ? '#4CAF50' : '#ff4444'};` : 
                        '';
                    
                    return `
                    <div class="watch-item" style="${style}">
                        <p>${car.name}</p>
                        <span class="remove-btn" onclick="removeFromWatchlist('${car.model}')">&times;</span>
                    </div>
                    `;
                }).join('');
                
                // Update floating button color
                updateFloatingButtonColor();
            }

            async function searchCar() {
                const searchInput = document.getElementById('searchInput');
                const searchTerm = searchInput.value.toLowerCase();
                const resultDiv = document.getElementById('result');
                resultDiv.style.display = 'none';
                
                if (!searchTerm) {
                    searchInput.style.borderColor = '#ff4444';
                    setTimeout(() => {
                        searchInput.style.borderColor = ''; // Reset to CSS variable after 1 second
                    }, 1000);
                    return;
                }

                try {
                    const data = await fetchDealershipData(false); // Force fresh API call for search
                    
                    let matches = [];
                    for (const category in data) {
                        const cars = data[category];
                        const matchedCars = cars.filter(car => 
                            car.name.toLowerCase().includes(searchTerm) || 
                            car.model.toLowerCase().includes(searchTerm)
                        );
                        
                        matchedCars.forEach(car => {
                            matches.push({ ...car, category });
                        });
                    }
                    
                    resultDiv.style.display = 'block';
                    
                    if (matches.length > 0) {
                        if (matches.length === 1) {
                            // Show all details for single match
                            const car = matches[0];
                            resultDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0;">Found 1 match:</h3>
                                    <button onclick="clearSearch()" style="padding: 4px 8px; background: var(--item-bg); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; color: var(--text-color);">Clear</button>
                                </div>
                                <div class="search-result-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                                    <p><strong>Name:</strong> ${car.name}</p>
                                    <p><strong>Model:</strong> ${car.model}</p>
                                    <p><strong>Category:</strong> ${car.category}</p>
                                    <p><strong>Price:</strong> ${car.price.toLocaleString()}</p>
                                    <p><strong>Days Left:</strong> ${car.days_left}</p>
                                    <button onclick='addToWatchlist(${JSON.stringify(car)}, "${car.category}")'>Watch</button>
                                </div>
                            `;
                        } else {
                            // Show only names for multiple matches
                            resultDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0;">Found ${matches.length} matches:</h3>
                                    <button onclick="clearSearch()" style="padding: 4px 8px; background: var(--item-bg); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; color: var(--text-color);">Clear</button>
                                </div>
                                ${matches.map(car => `
                                    <div class="search-result-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                        <span>${car.name}</span>
                                        <button onclick='addToWatchlist(${JSON.stringify(car)}, "${car.category}")' style="margin: 0;">Watch</button>
                                    </div>
                                `).join('')}
                            `;
                        }
                    } else {
                        resultDiv.innerHTML = '<p>No matching vehicle found</p>';
                    }
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                    if (error.message.includes('Daily API limit reached')) {
                        showApiLimitError();
                        window.parent.postMessage({
                            type: 'oneliner',
                            text: `Daily API calls limit (25) reached, please consider donating charges to increase the limit! /api donate 165625 amount`
                        }, '*');
                    } else {
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = '<p>Error searching for vehicle</p>';
                    }
                }
            }
        </script>
    </body>
</html>